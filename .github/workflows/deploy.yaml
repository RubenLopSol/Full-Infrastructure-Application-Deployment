name: CI/CD - Deploy to Minikube

on:
  push:
    branches:
      - main
  workflow_dispatch:  # permite ejecutarlo manualmente desde la UI de GitHub

jobs:
  build-and-deploy:
    name: Build & Deploy App to Minikube
    runs-on: self-hosted   # tu mÃ¡quina actuarÃ¡ como runner de GitHub Actions

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up environment variables
        run: |
          export AWS_ACCESS_KEY_ID=test
          export AWS_SECRET_ACCESS_KEY=test
          export AWS_DEFAULT_REGION=eu-west-1
          export AWS_ENDPOINT_URL=http://midominio.local

      - name: ğŸ³ Build Docker image
        run: |
          echo "ğŸš§ Building Docker image for the app..."
          docker build -t lahuella-app:latest .
          echo "ğŸ“¦ Image built successfully"

      - name: ğŸ“¤ Load image into Minikube
        run: |
          echo "ğŸš€ Loading image into Minikube..."
          minikube image load lahuella-app:latest

      - name: âš™ï¸ Apply Kubernetes manifests
        run: |
          echo "ğŸ“‚ Applying Kubernetes manifests..."
          kubectl apply -f infra/k8s/deployment-app.yaml
          kubectl apply -f infra/k8s/service-app.yaml
          kubectl apply -f infra/k8s/ingress-app.yaml
          echo "âœ… Application deployed successfully!"

      - name: ğŸ” Verify running pods
        run: |
          echo "ğŸ” Checking deployment status..."
          kubectl get pods -o wide

      - name: ğŸŒ Test application URL
        run: |
          kubectl get ingress
          echo "Try accessing http://midominio.local"
